<mat-card>
    <mat-card-content>
        <h3 class="fw-bold mb-6 page-title">Exam Time Table Report</h3>

        <form [formGroup]="timeTableFormGroup">
            <div class="row">

                <div class="col-md-2 col-6">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Session</mat-label>
                        <mat-select placeholder="Session" formControlName="academic_session_id">
                            <mat-option *ngFor="let session of state.academicSessionList"
                                [value]="session.academic_session_id">
                                {{ session.academic_session_name_e }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <div class="col-md-4 col-6">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Degree Programme Type</mat-label>
                        <mat-select placeholder="Degree Programme Type" formControlName="degree_programme_type_id">
                            <mat-option *ngFor="let degreeProType of state.degreeProgrammeTypeList"
                                [value]="degreeProType.degree_programme_type_id">
                                {{ degreeProType.degree_programme_type_name_e }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <div class="col-md-6 col-12">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Degree Programme</mat-label>
                        <mat-select placeholder="Degree Programme" formControlName="degree_programme_id">
                            <mat-option *ngFor="let degreeProgramme of state.degreeProgrammeList"
                                [value]="degreeProgramme.degree_programme_id">
                                {{ degreeProgramme.degree_programme_name_e }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <div class="col-md-4 col-6">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Course Year</mat-label>
                        <mat-select placeholder="Course Year" formControlName="course_year_id">
                            <mat-option *ngFor="let year of state.courseYearList" [value]="year.course_year_id">
                                {{ year.course_year_name_e }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <div class="col-md-4 col-6">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Semester</mat-label>
                        <mat-select placeholder="Semester" formControlName="semester_id">
                            <mat-option *ngFor="let semester of state.semesterList" [value]="semester.semester_id">
                                {{ semester.semester_name_e }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <div class="col-md-4 col-6">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Exam Type</mat-label>
                        <mat-select placeholder="Exam Type" formControlName="exam_type_id">
                            <mat-option *ngFor="let examType of state.examTypeList" [value]="examType.exam_type_id">
                                {{ examType.exam_type_name_e }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>


            </div>

            <div class="d-flex justify-content-center">
                <button type="submit" mat-raised-button color="primary" class="mt-3"
                    [disabled]="timeTableFormGroup.invalid" (click)="onSubmitFields()">
                    Get Details
                </button>
            </div>
        </form>


        <section #print_content>
            <div class="d-print-none text-end" *ngIf="this.registeredCourseList?.length > 0">
                <!-- <button mat-raised-button color="primary" matTooltip="Print" (click)="printData()"
                    class="tools mx-auto ms-1">
                    <mat-icon>print</mat-icon>
                </button> -->

                <button mat-raised-button color="primary" matTooltip="PDF" (click)="getPdf()"
                    class="tools mx-auto ms-1">
                    <!-- <mat-icon>picture_as_pdf</mat-icon> -->
                    <mat-icon>cloud_download</mat-icon>
                </button>
            </div>

            <table class="table table-bordered mt-3" *ngIf="this.registeredCourseList?.length > 0" #table>
                <thead>
                    <tr>
                        <th>SNo.</th>
                        <th>Year</th>
                        <th>Semester</th>
                        <th>Degree Programme</th>
                        <th>Exam Paper Type</th>
                        <th>Course Title</th>
                        <th>Exam Date</th>
                        <th>Exam Time</th>
                        <th>Exam Shift</th>
                        <th>Course Finalize</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Loop course_year_id groups -->
                    <ng-container *ngFor="let courseYearId of objectKeys(groupedData)">
                        <ng-container *ngFor="let semesterId of objectKeys(groupedData[courseYearId])">
                            <ng-container
                                *ngFor="let degreeProgrammeId of objectKeys(groupedData[courseYearId][semesterId])">
                                <ng-container
                                    *ngFor="let examTypeId of objectKeys(groupedData[courseYearId][semesterId][degreeProgrammeId])">

                                    <!-- Get all rows for this deepest group -->
                                    <ng-container
                                        *ngIf="groupedData[courseYearId][semesterId][degreeProgrammeId][examTypeId] as rows">

                                        <!-- Calculate rowspan counts for merged cells -->
                                        <tr *ngFor="let row of rows; let i = index">
                                            <td>
                                                {{i+1}}
                                            </td>

                                            <!-- Render course_year_id cell with rowspan on first row -->
                                            <td *ngIf="i === 0"
                                                [attr.rowspan]="getGroupRowSpan(courseYearId, groupedData)"
                                                style="vertical-align: top !important;">
                                                {{ getNameFromId(courseYearId, 'Course Year') }}
                                            </td>

                                            <!-- Render semester_id cell with rowspan on first row of semester group -->
                                            <td *ngIf="i === 0"
                                                [attr.rowspan]="getSubGroupRowSpan(courseYearId, semesterId, groupedData)"
                                                style="vertical-align: top !important;">
                                                {{ getNameFromId(semesterId, 'Semester') }}
                                            </td>

                                            <!-- Render degree_programme_id cell with rowspan on first row of degree programme group -->
                                            <td *ngIf="i === 0"
                                                [attr.rowspan]="getSubSubGroupRowSpan(courseYearId, semesterId, degreeProgrammeId, groupedData)"
                                                style="vertical-align: top !important;">
                                                {{ getNameFromId(degreeProgrammeId, 'Degree Program') }}
                                            </td>

                                            <!-- Render exam_type_id cell with rowspan on first row of exam type group -->
                                            <td *ngIf="i === 0" [attr.rowspan]="rows.length"
                                                style="vertical-align: top !important;">
                                                {{ getNameFromId(examTypeId, 'Exam Type') }}
                                            </td>

                                            <!-- Then render the row data -->
                                            <td class="text-start">{{ row?.course_name?.toUpperCase() }}</td>
                                            <!-- <td>{{ row.exam_date | date:'mediumDate' }}</td> -->
                                            <td style="white-space: nowrap !important;">
                                                {{ row.exam_date | date:'dd-MM-yyyy' }}
                                            </td>
                                            <td>{{ row.exam_time }}</td>
                                            <td>{{ row.exam_shift }}</td>
                                            <td>{{ row.is_finalize_yn === 'Y' ? 'Yes' : 'No' }}</td>
                                        </tr>
                                    </ng-container>

                                </ng-container>
                            </ng-container>
                        </ng-container>
                    </ng-container>
                </tbody>
            </table>
        </section>

    </mat-card-content>




</mat-card>